generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  Admin
  Editor
  Viewer
}

model User {
  id              String              @id @default(cuid()) @db.VarChar(32)
  avatarUrl       String?             @map("avatar_url") @db.VarChar(255)
  discordId       String              @unique @map("discord_id") @db.VarChar(255)
  email           String?             @unique @db.VarChar(255)
  name            String?             @db.VarChar(255)
  role            UserRole            @default(Viewer)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  lastLoginAt     DateTime?           @map("last_login_at")
  setting         Setting?            @relation("UserSetting")
  ownedFurnitures UserFurniture[]
  reactionChecks  UserReactionCheck[]

  @@map("users")
}

model Unit {
  id         String      @id @default(cuid()) @db.VarChar(32)
  bgColor    String      @map("bg_color") @db.VarChar(10)
  code       String      @unique @db.VarChar(20)
  color      String      @db.VarChar(10)
  name       String      @db.VarChar(20)
  priority   Int         @default(0)
  short      String      @db.VarChar(10)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  characters Character[]

  @@map("units")
}

model Character {
  id                 String                            @id @default(cuid()) @db.VarChar(32)
  avatarUrl          String?                           @map("avatar_url") @db.VarChar(255)
  bgColor            String                            @map("bg_color") @db.VarChar(10)
  code               String                            @unique @db.VarChar(20)
  color              String                            @db.VarChar(10)
  name               String                            @db.VarChar(20)
  priority           Int                               @default(0)
  short              String                            @db.VarChar(10)
  unitId             String?                           @map("unit_id") @db.VarChar(32)
  createdAt          DateTime                          @default(now()) @map("created_at")
  updatedAt          DateTime                          @updatedAt @map("updated_at")
  unit               Unit?                             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  groupExclusions    FurnitureGroupExcludedCharacter[]
  reactionCharacters FurnitureReactionCharacter[]

  @@map("characters")
}

model Setting {
  id             String   @id @default(cuid()) @db.VarChar(32)
  leaderSheetUrl String?  @map("leader_sheet_url") @db.VarChar(255)
  userId         String   @unique @map("user_id") @db.VarChar(32)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  user           User     @relation("UserSetting", fields: [userId], references: [id], onDelete: Cascade)

  @@map("settings")
}

model Heartbeat {
  id       Int      @id @default(1)
  lastSeen DateTime @map("last_seen") @db.Timestamptz(6)

  @@map("heartbeat")
}

model FurnitureTag {
  id         String      @id @db.VarChar(32)
  name       String      @unique @db.VarChar(100)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @map("updated_at")
  furnitures Furniture[]

  @@map("furniture_tags")
}

model Furniture {
  id        String              @id @db.VarChar(32)
  name      String              @db.VarChar(100)
  tagId     String              @map("tag_id") @db.VarChar(32)
  groupId   String?             @map("group_id") @db.VarChar(32)
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @map("updated_at")
  tag       FurnitureTag        @relation(fields: [tagId], references: [id], onDelete: Cascade)
  group     FurnitureGroup?     @relation(fields: [groupId], references: [id])
  reactions FurnitureReaction[]
  ownedBy   UserFurniture[]

  @@unique([tagId, name])
  @@map("furnitures")
}

model FurnitureReaction {
  id          String                       @id @db.VarChar(32)
  furnitureId String                       @map("furniture_id") @db.VarChar(32)
  createdAt   DateTime                     @default(now()) @map("created_at")
  updatedAt   DateTime                     @map("updated_at")
  furniture   Furniture                    @relation(fields: [furnitureId], references: [id], onDelete: Cascade)
  characters  FurnitureReactionCharacter[]
  checks      UserReactionCheck[]

  @@map("furniture_reactions")
}

model FurnitureReactionCharacter {
  id          String            @id @db.VarChar(32)
  reactionId  String            @map("reaction_id") @db.VarChar(32)
  characterId String            @map("character_id") @db.VarChar(32)
  createdAt   DateTime          @default(now()) @map("created_at")
  reaction    FurnitureReaction @relation(fields: [reactionId], references: [id], onDelete: Cascade)
  character   Character         @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([reactionId, characterId])
  @@map("furniture_reaction_characters")
}

model FurnitureGroup {
  id                 String                            @id @db.VarChar(32)
  name               String                            @unique @db.VarChar(100)
  createdAt          DateTime                          @default(now()) @map("created_at")
  updatedAt          DateTime                          @map("updated_at")
  furnitures         Furniture[]
  excludedCharacters FurnitureGroupExcludedCharacter[]

  @@map("furniture_groups")
}

model FurnitureGroupExcludedCharacter {
  id            String         @id @db.VarChar(32)
  groupId       String         @map("group_id") @db.VarChar(32)
  combinationId String         @map("combination_id") @db.VarChar(32)
  characterId   String         @map("character_id") @db.VarChar(32)
  createdAt     DateTime       @default(now()) @map("created_at")
  group         FurnitureGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  character     Character      @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([combinationId, characterId])
  @@index([groupId])
  @@map("furniture_group_excluded_characters")
}

model UserFurniture {
  id          String    @id @db.VarChar(32)
  userId      String    @map("user_id") @db.VarChar(32)
  furnitureId String    @map("furniture_id") @db.VarChar(32)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  furniture   Furniture @relation(fields: [furnitureId], references: [id], onDelete: Cascade)

  @@unique([userId, furnitureId])
  @@index([userId])
  @@map("user_furnitures")
}

model UserReactionCheck {
  id         String            @id @db.VarChar(32)
  userId     String            @map("user_id") @db.VarChar(32)
  reactionId String            @map("reaction_id") @db.VarChar(32)
  checkedAt  DateTime          @default(now()) @map("checked_at")
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  reaction   FurnitureReaction @relation(fields: [reactionId], references: [id], onDelete: Cascade)

  @@unique([userId, reactionId])
  @@index([userId])
  @@map("user_reaction_checks")
}
